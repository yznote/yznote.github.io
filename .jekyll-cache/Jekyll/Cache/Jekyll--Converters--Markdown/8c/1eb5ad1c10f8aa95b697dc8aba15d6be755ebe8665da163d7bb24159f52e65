I"—/<h4 id="åå°ä¿æ´»çš„å‡ ä¸ªæ–¹å‘">åå°ä¿æ´»çš„å‡ ä¸ªæ–¹å‘</h4>

<p>1.<strong>çŸ­æ—¶é—´ä¿æ´»</strong></p>
<blockquote>
  <p><code class="language-plaintext highlighter-rouge">beginBackgroundTaskWithName</code>å’Œ<code class="language-plaintext highlighter-rouge">endBackgroundTask</code>  <br />
æµ‹è¯•æœºå‹ã€iPhone6-12.4.7ã€‘åå°è¿è¡Œæ—¶é—´çº¦3åˆ†é’Ÿ(176ç§’)å·¦å³;<br />
æµ‹è¯•æœºå‹ã€iPhone6s-13.5.1ã€‘åå°è¿è¡Œæ—¶é—´34ç§’å·¦å³;</p>
</blockquote>

<p>2.<strong>åå°æŒç»­å®šä½</strong></p>
<blockquote>
  <p>è¿™ä¸ªé€‚ç”¨äºåœ°å›¾ç±»app,æˆ‘ä»¬æ˜¯ç›´æ’­éŸ³è§†é¢‘,ä¸é€‚ç”¨,æš‚ä¸”ä¸è®¨è®º;</p>
</blockquote>

<p>3.<strong>åå°ä¸‹è½½èµ„æº</strong></p>
<blockquote>
  <p>è¿™ä¸ªé€‚ç”¨äºä¸‹è½½æ¯”è¾ƒå¤§çš„æ–‡ä»¶ã€å¦‚:ç¦»çº¿åœ°å›¾ã€‘,ä¹Ÿä¸é€‚ç”¨,æš‚ä¸”ä¸è®¨è®º;</p>
</blockquote>

<p>4.<strong>æ’­æ”¾æ— å£°éŸ³ä¹</strong></p>
<blockquote>
  <p>ç±»æ¯”å‰å‡ ä¸ªæ–¹æ¡ˆ,è¿™ä¸ªæ˜¯æœ€é€‚åˆæˆ‘ä»¬çš„;</p>
</blockquote>

<p><strong>ä¸Šä»£ç </strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RKKeepAlive.h
#import &lt;Foundation/Foundation.h&gt;

#import &lt;AVFoundation/AVFoundation.h&gt;

static NSString *const kBgTaskName = @"com.rk.root777.KeepAlive";

@interface RKKeepAlive : NSObject

@property(nonatomic,assign)BOOL needKeepAliveInBackground;
@property(nonatomic,strong)AVAudioPlayer *player;

+(instancetype)sharedKeepInstance;

-(void)startAppLifeCycleMonitor;
@end
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RKKeepAlive.m
#import "RKKeepAlive.h"
#import "AppDelegate.h"

static RKKeepAlive *_keepInstance = nil;

@interface RKKeepAlive(){
    int vvvv;
    NSTimer *_timer;
}
@property (nonatomic, assign) UIBackgroundTaskIdentifier backgroundTaskIdentifier;
@end
@implementation RKKeepAlive

+(instancetype)sharedKeepInstance{
    static dispatch_once_t onceToken;
    dispatch_once(&amp;onceToken, ^{
        _keepInstance = [[super allocWithZone:NULL]init];
    });
    return _keepInstance;
}
+ (instancetype)allocWithZone:(struct _NSZone *)zone{
    return [self sharedKeepInstance];
}

- (void)initPlayer {
    [self.player prepareToPlay];
}
- (AVAudioPlayer *)player {
    if (!_player) {
        NSError *error = nil;
        NSURL *fileURL = [[NSBundle mainBundle] URLForResource:@"mute-mp3" withExtension:@"mp3"];
        AVAudioPlayer *audioPlayer = [[AVAudioPlayer alloc] initWithContentsOfURL:fileURL error:&amp;error];
        audioPlayer.numberOfLoops = NSUIntegerMax;
        _player = audioPlayer;
        
         AVAudioSession *session = [AVAudioSession sharedInstance];
        [[AVAudioSession sharedInstance] setMode:AVAudioSessionModeDefault error:nil];
        NSString* route = [[[[[AVAudioSession sharedInstance] currentRoute] outputs] objectAtIndex:0] portType];
        if ([route isEqualToString:AVAudioSessionPortHeadphones] || [route isEqualToString:AVAudioSessionPortBluetoothA2DP] || [route isEqualToString:AVAudioSessionPortBluetoothLE] || [route isEqualToString:AVAudioSessionPortBluetoothHFP]) {
            if (@available(iOS 10.0, *)) {
                [[AVAudioSession sharedInstance] setCategory:AVAudioSessionCategoryPlayAndRecord
                                                 withOptions:(AVAudioSessionCategoryOptionMixWithOthers | AVAudioSessionCategoryOptionAllowBluetooth | AVAudioSessionCategoryOptionAllowBluetoothA2DP)
                                                       error:nil];
            } else {
                // Fallback on earlier versions
            }
        }else{
            [[AVAudioSession sharedInstance] setCategory:AVAudioSessionCategoryPlayAndRecord
                                             withOptions:(AVAudioSessionCategoryOptionMixWithOthers | AVAudioSessionCategoryOptionDefaultToSpeaker)
                                                   error:nil];
        }
        
        [session setActive:YES error:nil];
        NSLog(@"%s åˆå§‹åŒ–==:%@",__FUNCTION__,error?[NSString stringWithFormat:@"å¤±è´¥:%@",error]:@"æˆåŠŸ");
    }
    return _player;
}

-(void)startAppLifeCycleMonitor{
    self.needKeepAliveInBackground = YES;
    YBWeakSelf;
    AppDelegate *appDelegate =  (AppDelegate *)[UIApplication sharedApplication].delegate;
    appDelegate.lifeCycleEvent = ^(YBAppLifeCycle lifeCycleType) {
        [weakSelf appDelegateBlockEvent:lifeCycleType];
    };
}
-(void)appDelegateBlockEvent:(YBAppLifeCycle)lifeCycleType {
    switch (lifeCycleType) {
        case APPLifeCycle_EnterForeground:{
            //[self appActive];
            //å‰å°
            NSLog(@"%sï¼šåº”ç”¨å°†è¿›å…¥å‰å°WillEnterForeground", __FUNCTION__);
            if (self.needKeepAliveInBackground) {
                [self.player pause];
            }
            [[UIApplication sharedApplication] endBackgroundTask:self.backgroundTaskIdentifier];
        }break;
        case APPLifeCycle_EnterBackground:{
            //[self backGround];
            //åå°
            self.backgroundTaskIdentifier = [[UIApplication sharedApplication] beginBackgroundTaskWithName:kBgTaskName expirationHandler:^{
                if (self.needKeepAliveInBackground) {
                    [self.player play];
                }
                if (self.backgroundTaskIdentifier != UIBackgroundTaskInvalid) {
                    [[UIApplication sharedApplication] endBackgroundTask:self.backgroundTaskIdentifier];
                    self.backgroundTaskIdentifier = UIBackgroundTaskInvalid;
                }
            }];
            NSLog(@"%sï¼šåº”ç”¨è¿›å…¥åå°DidEnterBackground", __FUNCTION__);
        }break;
        case APPLifeCycle_WillTerminate:{
            //æ€è¿›ç¨‹
            NSLog(@"%sï¼šåº”ç”¨ç»ˆæ­¢ï¼šWillTerminate", __FUNCTION__);
        }break;
            
        default:
            break;
    }
}
#pragma mark - ä¿æ´»æµ‹è¯•
-(void)backGround {
    [self setupTimer];
}
-(void)appActive {
    if (_timer) {
        [_timer invalidate];
        _timer = nil;
        vvvv = 0;
    }
}

#pragma mark - å®šæ—¶å™¨
- (void)setupTimer {
    vvvv = 1;
    
    _timer = [NSTimer timerWithTimeInterval:1.0 target:self selector:@selector(timerEvent:) userInfo:nil repeats:YES];
    [[NSRunLoop currentRunLoop] addTimer:_timer forMode:NSRunLoopCommonModes];
    [_timer fire];
}

- (void)timerEvent:(id)sender {
    vvvv ++;
    NSLog(@"æ™®é€šå®šæ—¶å™¨è¿è¡Œä¸­:%d",vvvv);
    
    if (vvvv%60 == 0) {
        [[NSUserDefaults standardUserDefaults] setObject:[NSString stringWithFormat:@"%d",vvvv] forKey:@"rk_keep_alive_time"];
    }
}

@end

</code></pre></div></div>

<h4 id="ä½¿ç”¨">ä½¿ç”¨</h4>

<p>1.åœ¨<code class="language-plaintext highlighter-rouge">AppDelegate.h</code>ä¸­å£°æ˜ä¸€ä¸‹ç»“æ„ä½“å’Œå±æ€§</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typedef NS_ENUM(NSInteger,YBAppLifeCycle) {
    APPLifeCycle_Default,           //é»˜è®¤
    APPLifeCycle_EnterForeground,   //è¿›å…¥å‰å°
    APPLifeCycle_EnterBackground,   //è¿›å…¥åå°
    APPLifeCycle_WillTerminate,     //æ€è¿›ç¨‹
};
typedef void(^YBAppLifeCycleBlock) (YBAppLifeCycle lifeCycleType);

@interface AppDelegate : YBBaseAppDelegate

@property(nonatomic,copy)YBAppLifeCycleBlock lifeCycleEvent;
</code></pre></div></div>
<p>2.åœ¨<code class="language-plaintext highlighter-rouge">launchOptions</code>ä¸­è®¾ç½®ç›‘å¬</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    //ç”Ÿå‘½å‘¨æœŸç›‘å¬
    [[RKKeepAlive sharedKeepInstance] startAppLifeCycleMonitor];
</code></pre></div></div>
<p>3.åœ¨ä»¥ä¸‹å‡ ä¸ªç³»ç»Ÿæ–¹æ³•ä¸­è®¾ç½®å›è°ƒ</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#pragma mark - æ€è¿›ç¨‹
- (void)applicationWillTerminate:(UIApplication *)application{
    if (self.lifeCycleEvent) {
        self.lifeCycleEvent(APPLifeCycle_WillTerminate);
    }
}
#pragma mark - Appè¿›å…¥åå°
- (void)applicationDidEnterBackground:(UIApplication *)application {
    
    if (self.lifeCycleEvent) {
        self.lifeCycleEvent(APPLifeCycle_EnterBackground);
    }
}
#pragma mark - Appå°†è¦ä»åå°è¿”å›
- (void)applicationWillEnterForeground:(UIApplication *)application {
    
    if (self.lifeCycleEvent) {
        self.lifeCycleEvent(APPLifeCycle_EnterForeground);
    }
    
}
</code></pre></div></div>

<h4 id="è¿è¡Œç»“æœ">è¿è¡Œç»“æœ</h4>
<div style="background-color:rgba(0,0,0,0.8); width: 100%;height: 420px;border-radius: 5px;color: #fff;padding-top: 10px;">
     <div style="float:left;border:solid 1px 000;width: 45%;padding-left: 5%"><img src="/img/20200722/1.jpg" width="200" height="260" /></div>
     <div style="float:left; border:solid 1px 000;width: 45%;padding-left: 5%"><img src="/img/20200722/2.jpg" width="200" height="260" /></div>
</div>
<div style="float:none;clear:both;width: 100%;height: 50px"> </div>
<!-- http://www.cocoachina.com/articles/896173   -->
<!-- https://juejin.im/post/5cf7eb0351882576710e5c15#heading-14 -->

<h4 id="æ€»ç»“">æ€»ç»“</h4>

<div style="color: #DC143C;font-weight: bold;">æœªç»è¿‡å¤§é‡ç»Ÿè®¡</div>
<blockquote>
  <p>æµ‹è¯•æ–¹å¼:æ’­æ”¾åå°éŸ³ä¹<br />
æµ‹è¯•æ—¶é—´: 7-22  21:00å¼€å§‹   7-23 9:20ç»“æŸ<br />
æµ‹è¯•æ—¶é—´[s]:iPhone6sã€44160sã€‘ã€iPhone6ã€43260sã€‘ã€éƒ½æ˜¯ä¸€åˆ†é’Ÿå†™ä¸€æ¬¡è®°å½•ã€‘<br />
å‹å·:iPhone6sã€13.5.1ã€‘ã€iPhone6ã€12.4.7ã€‘<br />
ç”µæ± å³°å€¼:iPhone6sã€76%ã€‘ã€iPhone6ã€100%-æ¢è¿‡ç”µæ± ã€‘<br />
ç”µé‡:iPhone6sã€100%æ¶ˆè€—åˆ°52%-æ¶ˆè€—48%ã€‘ã€iPhone6ã€80%æ¶ˆè€—åˆ°25%-æ¶ˆè€—55%ã€‘</p>
</blockquote>

<blockquote>
  <p>æµ‹è¯•æ–¹å¼:æ€æ‰æ‰€æœ‰åº”ç”¨è¿›ç¨‹<br />
æµ‹è¯•æ—¶é—´:7-23 18:00  7-24 8.20<br />
å‹å·:iPhone6sã€13.5.1ã€‘ã€iPhone6ã€12.4.7ã€‘<br />
ç”µæ± å³°å€¼:iPhone6sã€76%ã€‘ã€iPhone6ã€100%-æ¢è¿‡ç”µæ± ã€‘<br />
ç”µé‡:iPhone6sã€100%æ¶ˆè€—åˆ°56%-æ¶ˆè€—44%ã€‘(ä¸å¯æ€è®®ç”µæ± æœ‰é—®é¢˜ï¼Ÿ)ã€iPhone6ã€100%-æ¶ˆè€—0ã€‘</p>
</blockquote>

<h4 id="æ‹“å±•">æ‹“å±•</h4>

<ul>
  <li>å‚è€ƒå­¦ä¹ ç½‘å€ï¼š</li>
  <li><code class="language-plaintext highlighter-rouge">App</code>æ¥å…¥<code class="language-plaintext highlighter-rouge">iOS 11</code>çš„<code class="language-plaintext highlighter-rouge">Files App</code>:<a href="https://www.jianshu.com/p/61b4e26ab413">https://www.jianshu.com/p/61b4e26ab413</a></li>
  <li><code class="language-plaintext highlighter-rouge">iOS</code>åå°æŒ‚èµ·çš„ä¸€äº›å‘:<a href="https://www.cnblogs.com/saytome/p/7080056.html">https://www.cnblogs.com/saytome/p/7080056.html</a></li>
  <li><code class="language-plaintext highlighter-rouge">iOS</code>å¦‚ä½•å®æ—¶æŸ¥çœ‹<code class="language-plaintext highlighter-rouge">App</code>è¿è¡Œæ—¥å¿—:<a href="http://www.cocoachina.com/articles/19933">http://www.cocoachina.com/articles/19933</a></li>
  <li><code class="language-plaintext highlighter-rouge">iOS</code>ç‰ˆå¾®ä¿¡æ¨é€å³æ—¶æ¶ˆæ¯æ˜¯å¦‚ä½•å®ç°çš„:<a href="https://www.zhihu.com/question/20654687">https://www.zhihu.com/question/20654687</a></li>
  <li><code class="language-plaintext highlighter-rouge">iPhone</code>åœ¨ä¸€ä¸ªå°æ—¶å†…,æ¥å—æ¨é€çš„æ¬¡æ•°æœ‰é™åˆ¶å—:<a href="https://community.jiguang.cn/t/iphone/2511">https://community.jiguang.cn/t/iphone/2511</a></li>
  <li>ä¸ºä»€ä¹ˆ<code class="language-plaintext highlighter-rouge">iOS</code>çš„å¾®ä¿¡æ²¡æœ‰å¸¸é©»åå°,ä¹Ÿèƒ½æ”¶åˆ°æ–°æ¶ˆæ¯é€šçŸ¥:<a href="https://mlog.club/article/45386">https://mlog.club/article/45386</a></li>
  <li><code class="language-plaintext highlighter-rouge">iOS</code>åå°è¿è¡Œçš„ç›¸å…³æ–¹æ¡ˆæ€»ç»“:<a href="https://ctinusdev.github.io/2016/05/10/BackgroundTask/">https://ctinusdev.github.io/2016/05/10/BackgroundTask/</a></li>
  <li><code class="language-plaintext highlighter-rouge">iOS</code>ä¹‹åŸç”Ÿåœ°å›¾çš„ä½¿ç”¨è¯¦è§£:<a href="https://blog.csdn.net/u011146511/article/details/51245469">https://blog.csdn.net/u011146511/article/details/51245469</a></li>
  <li><code class="language-plaintext highlighter-rouge">iOS</code>é¡¹ç›®æŠ€æœ¯è¿˜å€ºä¹‹è·¯ã€Šä¸€ã€‹åå°ä¸‹è½½è¶Ÿå‘:<a href="https://juejin.im/post/5cf7eb0351882576710e5c15">https://juejin.im/post/5cf7eb0351882576710e5c15</a></li>
</ul>

:ET