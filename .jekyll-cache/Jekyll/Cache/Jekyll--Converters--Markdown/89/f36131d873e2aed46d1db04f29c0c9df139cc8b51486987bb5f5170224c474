I"œ9<h4 id="ç½‘ä¸Šä¾‹å­æ¯”è¾ƒå¤šæ­¥éª¤ç®€å•å›é¡¾">ç½‘ä¸Šä¾‹å­æ¯”è¾ƒå¤šæ­¥éª¤ç®€å•å›é¡¾</h4>

<p><strong>ç¬¬ä¸€æ­¥:<code class="language-plaintext highlighter-rouge">Projext</code> - <code class="language-plaintext highlighter-rouge">Localizations</code> - <code class="language-plaintext highlighter-rouge">+</code> è‡ªå·±éœ€è¦çš„è¯­è¨€</strong></p>

<p><strong>ç¬¬äºŒæ­¥:<code class="language-plaintext highlighter-rouge">Targets</code> - <code class="language-plaintext highlighter-rouge">Info</code> æ·»åŠ  <code class="language-plaintext highlighter-rouge">Localized resources can be mixed</code> <code class="language-plaintext highlighter-rouge">YES</code></strong></p>

<blockquote>
  <p>å¥½åƒéå¿…é¡»,è¿˜æœªææ‡‚â€¦</p>
</blockquote>

<p><strong>ç¬¬ä¸‰æ­¥:åˆ›å»º <code class="language-plaintext highlighter-rouge">Strings File</code> å‘½å <code class="language-plaintext highlighter-rouge">InfoPlist</code> å’Œ <code class="language-plaintext highlighter-rouge">Localizable</code></strong></p>

<blockquote>
  <p>InfoPlist.strings å­˜æ”¾ç³»ç»Ÿçš„å›½é™…åŒ–<br />
Localizable.strings å­˜æ”¾æœ¬åœ°çš„å›½é™…åŒ–</p>
</blockquote>

<p><strong>é€‰ä¸­<code class="language-plaintext highlighter-rouge">InfoPlist</code>æˆ–è€…<code class="language-plaintext highlighter-rouge">Localizable</code>å³ä¾§è¾¹æ å‹¾é€‰éœ€è¦çš„è¯­è¨€å°±ä¼šäº§ç”Ÿä¸‹æ‹‰æ¡†,ä¸åŒçš„è¯­è¨€åŒºåˆ†æ–‡ä»¶å¡«å†™</strong></p>

<h4 id="æ–¹æ³•å®ç°">æ–¹æ³•å®ç°</h4>

<p><strong>Objextive-c</strong></p>

<p><em>å®æ–‡ä»¶</em></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#define YZMsg(key) [[RookieTools shareInstance] getStringForKey:key withTable:@"InfoPlist"]
#define CurrentLanguage @"will_show_language"
#define getImagename(a) [NSString stringWithFormat:@"%@%@",a,[Config canshu]]
#define lagType [[NSUserDefaults standardUserDefaults] objectForKey:CurrentLanguage]
#define ZH_CN @"zh-Hans"
#define EN @"en"

</code></pre></div></div>
<p><em>.h</em></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@interface RookieTools : NSObject

+(id)shareInstance;
/**
 *  è¿”å›tableä¸­æŒ‡å®šçš„keyçš„å€¼
 *
 *  @param key   key
 *  @param table table
 *
 *  @return è¿”å›tableä¸­æŒ‡å®šçš„keyçš„å€¼
 */
-(NSString *)getStringForKey:(NSString *)key withTable:(NSString *)table;
/**
 *  é‡ç½®è¯­è¨€
 *
 *  @param language æ–°è¯­è¨€
 */
-(void)resetLanguage:(NSString*)language withFrom:(NSString *)appdelegate;

@end

</code></pre></div></div>
<p><em>.m</em></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>static RookieTools *shareTool = nil;

@interface RookieTools()

@property(nonatomic,strong)NSBundle *bundle;
@property(nonatomic,copy)NSString *language;

@end

@implementation RookieTools
+ (void)load {
    // äº¤æ¢MJçš„å›½é™…åŒ–æ–¹æ³•
    Method mjMethod = class_getClassMethod([NSBundle class],@selector(mj_localizedStringForKey:value:));
    Method myMethod = class_getClassMethod(self, @selector(hook_mj_localizedStringForKey:value:));
    method_exchangeImplementations(mjMethod, myMethod);
}
/// hookåˆ·æ–°æ§ä»¶çš„æç¤ºæ–‡å­—
+ (NSString *)hook_mj_localizedStringForKey:(NSString *)key value:(NSString *)value {
    NSString *language;
    if ([lagType isEqual:ZH_CN]) {
        language = @"zh-Hans";
    }else{
        language = @"en";
    }
    NSBundle *bundle = [NSBundle bundleWithPath:[[NSBundle mj_refreshBundle] pathForResource:language ofType:@"lproj"]];
    return [bundle localizedStringForKey:key value:nil table:@"Localizable"];
}

+(id)shareInstance {
    @synchronized (self) {
        if (shareTool == nil) {
            shareTool = [[RookieTools alloc]init];
        }
    }
    return shareTool;
}
+(instancetype)allocWithZone:(struct _NSZone *)zone {
    if (shareTool == nil) {
        shareTool = [super allocWithZone:zone];
    }
    return shareTool;
}

-(NSString *)getStringForKey:(NSString *)key withTable:(NSString *)table {
    if (self.bundle) {
        return NSLocalizedStringFromTableInBundle(key, table, self.bundle, @"");
    }
    return NSLocalizedStringFromTable(key, table, @"");
}

-(void)resetLanguage:(NSString *)language withFrom:(NSString *)appdelegate{
    if ([language isEqualToString:self.language]) {
        return;
    }
    if ([language isEqualToString:@"en"] || [language isEqualToString:@"zh-Hans"]) {
        NSString *path = [[NSBundle mainBundle]pathForResource:language ofType:@"lproj"];
        self.bundle = [NSBundle bundleWithPath:path];
    }
    self.language = language;
    [[NSUserDefaults standardUserDefaults] setObject:language forKey:CurrentLanguage];

    [[NSUserDefaults standardUserDefaults]synchronize];
    if (![appdelegate isEqualToString:@"appdelegate"]) {
        [self resetRootViewController];
    }
    
    // ===&gt;20220426 å¹¶æ–°å¢NSBundleæ‰©å±•
    NSMutableArray *userDefaultLanguages = [[NSUserDefaults standardUserDefaults]objectForKey:@"AppleLanguages"];
    NSLog(@"rk-language-tool-get:%@",userDefaultLanguages);
    NSString *langStr = @"zh-Hans-US";
    if (![lagType isEqual:ZH_CN]) {
        langStr = @"en-US";
    }
    [NSBundle setLanguage:langStr];
    [[NSUserDefaults standardUserDefaults] setObject:[NSArray arrayWithObjects:langStr,nil] forKey:@"AppleLanguages"];
    [[NSUserDefaults standardUserDefaults] synchronize];
    
    NSMutableArray *userDefaultLanguages1 = [[NSUserDefaults standardUserDefaults]objectForKey:@"AppleLanguages"];
    NSLog(@"rk-language-tool-set:%@",userDefaultLanguages1);
    // &lt;===20220426

}
-(void)resetRootViewController {
    UIWindow *window = [UIApplication sharedApplication].keyWindow;
    
    YBTabBarController *root = [[YBTabBarController alloc]init];
    UINavigationController *navi = [[UINavigationController alloc]initWithRootViewController:root];
    window.rootViewController = navi;
    [[TUIKit sharedInstance] initKit:TXIMSdkAppid accountType:TXIMSdkAccountType withConfig:[TUIKitConfig defaultConfig]];

//    [root changeLanguage];
    
}

@end

</code></pre></div></div>

<p><strong>NSBundleæ‰©å±•</strong></p>
<blockquote>
  <p>æ³¨æ„:ç›®å‰æ²¡æœ‰å‘ç°æœ‰ä»€ä¹ˆä½œç”¨,åˆ‡æ¢è¯­è¨€ç«‹å³æ‰“å¼€ç³»ç»Ÿç›¸æœºè¿˜æ˜¯ä¸ä¼šç«‹åˆ»å‘ç”Ÿå˜åŒ–â€¦</p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">.h</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//
//  NSBundle+RKLanguage.h
//  iphoneLive
//
//  Created by YB007 on 2022/4/20.
//  Copyright Â© 2022 cat. All rights reserved.
//

#import &lt;Foundation/Foundation.h&gt;

NS_ASSUME_NONNULL_BEGIN

@interface NSBundle (RKLanguage)


// è®¾ç½®è¯­è¨€
+ (void)setLanguage:(NSString *)language;

@end

NS_ASSUME_NONNULL_END

</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">.m</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//
//  NSBundle+RKLanguage.m
//  iphoneLive
//
//  Created by YB007 on 2022/4/20.
//  Copyright Â© 2022 cat. All rights reserved.
//

#import "NSBundle+RKLanguage.h"

#import &lt;objc/runtime.h&gt;

static const char _bundle = 0;

@interface BundleEx : NSBundle

@end

@implementation BundleEx

- (NSString *)localizedStringForKey:(NSString *)key value:(NSString *)value table:(NSString *)tableName {
    NSBundle *bundle = objc_getAssociatedObject(self, &amp;_bundle);
    NSString *locStr = bundle ? [bundle localizedStringForKey:key value:value table:tableName] : [super localizedStringForKey:key value:value table:tableName];
    NSLog(@"rk-language-budle-set-val:%@",locStr);
    return locStr;
}

@end


@implementation NSBundle (RKLanguage)

+ (void)setLanguage:(NSString *)language {
    static dispatch_once_t onceToken;
    dispatch_once(&amp;onceToken, ^{
        object_setClass([NSBundle mainBundle], [BundleEx class]);
    });
    objc_setAssociatedObject([NSBundle mainBundle], &amp;_bundle, language ? [NSBundle bundleWithPath:[[NSBundle mainBundle] pathForResource:language ofType:@"lproj"]] : nil, OBJC_ASSOCIATION_RETAIN_NONATOMIC);
    NSLog(@"rk-language-budle-set-language:%@",language);
}

@end

</code></pre></div></div>

<p><strong>Swift</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import UIKit
import MJRefresh
/// é”®å€¼æ›¿æ¢
func rkLocalized(key:String) -&gt; String {
    let currnetL = rkLanguageType()
    let getPath = Bundle.main.path(forResource: currnetL as String, ofType: "lproj")
    guard let pathL = getPath else {
        return key
    }
    let getValue = Bundle.init(path: pathL)?.localizedString(forKey: key as String, value: nil, table: "Localizable")
    let value:String = getValue ?? key
    return value
}

/// åˆå§‹åŒ–
private let onceToken = "Method Swizzling"
func rkLanguageInit() {
    if (UserDefaults.standard.object(forKey: rkLanguageKey) == nil) {
        let languageArray = NSLocale.preferredLanguages;
        let languageStr = languageArray[0]
        if languageStr.hasPrefix(rkZhCn as String) {
            UserDefaults.standard.set(rkZhCn, forKey: rkLanguageKey)
        }else{
            UserDefaults.standard.set(rkEn, forKey: rkLanguageKey)
        }
        UserDefaults.standard.synchronize()
    }
    
    //åŠ¨æ€è®¾ç½®MJå›½é™…åŒ–
    let langClas = RKHook()
    langClas.mjLanguage()
//    langClas.hookTest()
    
}

/// è·å–è¯­è¨€
func rkLanguageType() -&gt; String {
    return UserDefaults.standard.object(forKey: rkLanguageKey) as! String
}

/// åˆ‡æ¢è¯­è¨€
func rkSwitchLanguage() {
    let currentL = rkLanguageType()
    if currentL.isEqual(rkEn) {
        UserDefaults.standard.set(rkZhCn, forKey: rkLanguageKey)
    }else{
        UserDefaults.standard.set(rkEn, forKey: rkLanguageKey)
    }
    UserDefaults.standard.synchronize()
    
    let tabVC = RKTabBarController()
    UIApplication.shared.rkWindow?.rootViewController = tabVC
    UIApplication.shared.rkWindow?.makeKeyAndVisible()
    tabVC.selectedIndex = 4
    let setVC = RKSetVC()
    UIApplication.shared.pushViewController(setVC, animated: false)
    
}
/**
 * Swift è‡ªå®šä¹‰ç±»ä½¿ç”¨ method swizzling
 * 1.åŒ…å« swizzle çš„classå¿…é¡»æ˜¯ç»§æ‰¿è‡ª NSObject
 * 2.swizzle æ–¹æ³•å¿…é¡»æœ‰åŠ¨æ€å±æ€§
 */
class RKHook:NSObject {
    @objc  var aBool: Bool = true
    /// æµ‹è¯•æ–¹æ³•
    @objc func hookTest(){
        var methodNum:UInt32 = 0
        let rkHook:RKHook = RKHook()
        let methodList = class_copyMethodList(object_getClass(rkHook), &amp;methodNum)
        rkprint("method-start")
        for index in 0 ..&lt; numericCast(methodNum) {
            
            let method: Method = methodList![index]
            rkprint(String(utf8String: method_getTypeEncoding(method)!) as Any)
            rkprint(String(utf8String: method_copyReturnType(method)) as Any)
            rkprint(String(_sel:method_getName(method)))
            rkprint("==a:\(method_getImplementation(method))")
        }
        rkprint("method-end")
        
        rkprint("property-start")
        var propertyNums:UInt32 = 0
        let propertyList = class_copyPropertyList(object_getClass(rkHook), &amp;propertyNums)
        for index in 0 ..&lt; numericCast(propertyNums) {
            let property:objc_property_t = propertyList![index]
            rkprint(String(utf8String: property_getName(property)) as Any)
            rkprint(String(utf8String: property_getAttributes(property)!) as Any)
        }
        rkprint("property-end")
    }
    /// åŠ¨æ€è®¾ç½®MJçš„å›½é™…åŒ–
    @objc func mjLanguage() {
        DispatchQueue.once(token: onceToken) {
            let mj_selector = #selector(Bundle.mj_localizedString(forKey:value:))
            let hook_selector = #selector(self.hook_mj_localizedString(forKey:value:))
            
            let mjMethod = class_getClassMethod(Bundle.self, mj_selector)
            let hookMethod = class_getInstanceMethod(RKHook.self, hook_selector)
            method_exchangeImplementations(mjMethod!, hookMethod!)
            
            /*
            //åœ¨è¿›è¡Œ Swizzling çš„æ—¶å€™,éœ€è¦ç”¨ class_addMethod å…ˆè¿›è¡Œåˆ¤æ–­ä¸€ä¸‹åŸæœ‰ç±»ä¸­æ˜¯å¦æœ‰è¦æ›¿æ¢æ–¹æ³•çš„å®ç°
            let didAddMethod: Bool = class_addMethod(Bundle.self, mj_selector, method_getImplementation(hookMethod!), method_getTypeEncoding(hookMethod!))
            //å¦‚æœ class_addMethod è¿”å› yes,è¯´æ˜å½“å‰ç±»ä¸­æ²¡æœ‰è¦æ›¿æ¢æ–¹æ³•çš„å®ç°,æ‰€ä»¥éœ€è¦åœ¨çˆ¶ç±»ä¸­æŸ¥æ‰¾,è¿™æ—¶å€™å°±ç”¨åˆ° method_getImplemetation å»è·å– class_getInstanceMethod é‡Œé¢çš„æ–¹æ³•å®ç°,ç„¶åå†è¿›è¡Œ class_replaceMethod æ¥å®ç° Swizzing
            if didAddMethod {
                class_replaceMethod(RKHook.self, hook_selector, method_getImplementation(mjMethod!), method_getTypeEncoding(mjMethod!))
            } else {
                method_exchangeImplementations(mjMethod!, hookMethod!)
            }
            */
        }
    }
    
    @objc dynamic func hook_mj_localizedString(forKey:String,value:String) -&gt; String{
        let currentL = rkLanguageType()
        var mjLanguage:String = ""
        if currentL.isEqual(rkEn) {
            mjLanguage = "en"
        }else{
            mjLanguage = "zh-Hans"
        }
        let getPath = Bundle.mj_refresh().path(forResource: mjLanguage, ofType: "lproj")
        //rkprint("===kk:\(String(describing: getPath))")
        guard let pathL = getPath else {
            return currentL
        }
        let rkMjBundle = Bundle.init(path: pathL)
        guard let getMjb = rkMjBundle else {
            return currentL
        }
        let getValue = getMjb.localizedString(forKey: forKey, value: nil, table: "Localizable")
        let value:String = getValue
        //rkprint("kkkllll:\(forKey)\nbbbbb:\(value)")
        return value
    }
    
}

</code></pre></div></div>
<h4 id="æ¨é€">æ¨é€</h4>

<p><a href="https://segmentfault.com/a/1190000020720814">æ¨é€å›½é™…åŒ–</a></p>

<h4 id="æ€»ç»“">æ€»ç»“</h4>

<p><code class="language-plaintext highlighter-rouge">oc</code>ä¸­å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">load</code>æ–¹æ³•æ¥æ¥å®ç°åŠ¨æ€æ”¹å˜<code class="language-plaintext highlighter-rouge">MJ</code>çš„å›½é™…åŒ–</p>

<p><code class="language-plaintext highlighter-rouge">Swift</code>è¦æƒ³åˆ©ç”¨<code class="language-plaintext highlighter-rouge">oc</code>çš„è¿è¡Œæ—¶éœ€è¦æ³¨æ„ä¸¤ç‚¹:<br />
<code class="language-plaintext highlighter-rouge">1.ç»§æ‰¿è‡ªNSObject</code> <br />
<code class="language-plaintext highlighter-rouge">2.åŠ¨æ€å±æ€§</code></p>

<p><strong>å‚è€ƒ</strong><br />
<a href="https://segmentfault.com/a/1190000004715337">å¦‚ä½•åœ¨ Swift ä¸­é«˜æ•ˆåœ°ä½¿ç”¨ Method Swizzling</a></p>

:ET