I"­3<h4 id="å¤šå±‚scrollviewåµŒå¥—-scrollé¡¶éƒ¨åˆ·æ–°">å¤šå±‚<code class="highlighter-rouge">Scrollview</code>åµŒå¥— ã€scrollé¡¶éƒ¨åˆ·æ–°ã€‘</h4>

<blockquote>
  <p>åº•éƒ¨æ˜¯ä¸€ä¸ª<code class="highlighter-rouge">scrllview</code>,å­ç±»æ˜¯<code class="highlighter-rouge">collectionview</code>,è¦æ±‚å‘ä¸Šæ»‘åŠ¨çš„æ—¶å€™<code class="highlighter-rouge">scrllview</code>å’Œ<code class="highlighter-rouge">collectionview</code>å¯ä»¥åšåˆ°è¿ç»­æ»‘åŠ¨</p>
</blockquote>

<p>çº¦å®š: åº•éƒ¨<code class="highlighter-rouge">ScollView</code>æˆ‘ä»¬ç§°ä¹‹ä¸º<code class="highlighter-rouge">MainScroll</code>,å­ç±»<code class="highlighter-rouge">CollectionView</code>ç§°ä¹‹ä¸º<code class="highlighter-rouge">SubCollectionView</code></p>

<p><strong>é¦–å…ˆæˆ‘ä»¬å†™ä¸€ä¸ª<code class="highlighter-rouge">ScrollView</code>çš„åŸºç±»</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@interface RKScrollView : UIScrollView&lt;UIGestureRecognizerDelegate&gt;

@end

@implementation HoverPageScrollView

- (BOOL)touchesShouldCancelInContentView:(UIView *)view{
    return YES;
}
- (BOOL)gestureRecognizer:(UIGestureRecognizer *)gestureRecognizer shouldRecognizeSimultaneouslyWithGestureRecognizer:(UIGestureRecognizer *)otherGestureRecognizer{
    
    return YES;
}
@end
</code></pre></div></div>

<p><strong><code class="highlighter-rouge">MainScrollView</code>ç»§æ‰¿<code class="highlighter-rouge">RKScrollView</code></strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    //æ³¨æ„è¿™é‡Œçˆ¶ç±»æœ‰ä¸ªå±æ€§_canScrollé»˜è®¤è®¾ç½®ä¸ºYES
    _canScroll = YES;

    _mainScrollview = [[RKScrollView alloc]initWithFrame:CGRectMake(0, 0, _window_width, _window_height-78-statusbarHeight-ShowDiff-49)];
    _mainScrollview.backgroundColor = [UIColor whiteColor];
    _mainScrollview.contentSize = CGSizeMake(0, _mainScrollview.height+400);
    //é‡è¦å±æ€§ã€å¦‚æœéœ€è¦ä¸‹æ‹‰åˆ·æ–°å¯åœ¨didscrollä»£ç†ä¸­æ›´æ”¹æ­¤å±æ€§ã€‘
    _mainScrollview.bounces = NO;
    _mainScrollview.delegate = self;
    _mainScrollview.scrollViewWhites = [NSMutableArray array];
    [self.view addSubview:_mainScrollview];
</code></pre></div></div>

<p><strong><code class="highlighter-rouge">MainScrollview</code>ä»£ç†æ–¹æ³•ä¸­çš„å®ç°</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-(void)scrollViewDidScroll:(UIScrollView *)scrollView{

    //MainScrollviewä¸éœ€è¦åˆ·æ–°è¿™é‡Œå¯ä¸åšå¤„ç†
    if (scrollView == _mainScrollview){
        
        if (scrollView.contentOffset.y &lt;= 0) {
            _mainScrollview.bounces = YES;
            subCollectionView.bounces = NO;
            
        }else{
            _mainScrollview.bounces = NO;
            subCollectionView.bounces = YES;
        }
    }
    
    CGFloat bottomCellOffset = tableHeaderView.height-40;//è¿™é‡Œé«˜åº¦è®¾ç½®ä¸ºå¤´éƒ¨è§†å›¾é«˜åº¦å³å¯
    if (scrollView.contentOffset.y &gt;= bottomCellOffset) {
        scrollView.contentOffset = CGPointMake(0, bottomCellOffset);
        if (_canScroll) {
            _canScroll = NO;
            subCollectionView.canScroll = YES;
        }
    }else{
        if (!_canScroll) {//å­è§†å›¾æ²¡åˆ°é¡¶éƒ¨
            scrollView.contentOffset = CGPointMake(0, bottomCellOffset);
        }
    }
    _mainScrollview.showsVerticalScrollIndicator = _canScroll?YES:NO;
    
}
- (void)changeScrollStatus {
    _canScroll = YES;
    subCollectionView.canScroll = NO;
}
</code></pre></div></div>

<p><strong>å­ç±»<code class="highlighter-rouge">subCollectionView</code></strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-(void)scrollViewDidScroll:(UIScrollView *)scrollView{
    
    if (!_canScroll) {
        scrollView.contentOffset = CGPointZero;
    }
    if (scrollView.contentOffset.y &lt;= 0) {
        
        _canScroll = NO;
        scrollView.contentOffset = CGPointZero;
        //è¿™é‡Œå°±æ˜¯é€šçŸ¥çˆ¶ç±»æ”¹å˜çˆ¶ç±»çš„canScrollå±æ€§
        if (_delegate &amp;&amp; [_delegate respondsToSelector:@selector(changeScrollStatus)]) {
            [_delegate changeScrollStatus];
        }
    }
    _subCollectionView.showsVerticalScrollIndicator = _canScroll?YES:NO;
}

</code></pre></div></div>

<h4 id="ä»¿æ”¯ä»˜å®é¦–é¡µåˆ·æ–°tableviewåˆ·æ–°">ä»¿æ”¯ä»˜å®é¦–é¡µåˆ·æ–°ã€tableviewåˆ·æ–°ã€‘</h4>

<p><a href="http://www.demodashi.com/demo/12753.html">å‚è€ƒé“¾æ¥</a></p>

<p><strong>å®Œæ•´ä»£ç </strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#import "TBRefreshVC.h"

#import &lt;MJRefresh.h&gt;

#define KScreenWidth  [UIScreen mainScreen].bounds.size.width
#define KScreenHeight [UIScreen mainScreen].bounds.size.height
#define KTopViewHeight  300
#define KTopHeaderViewHeight  80

@interface TBRefreshVC ()&lt;UITableViewDelegate,UITableViewDataSource&gt;

@property (nonatomic, strong) UIScrollView *scrollView;
@property (nonatomic, strong) UITableView *tableView;
@property (nonatomic, strong) UIView *topView;
@property (nonatomic, strong) UIView *navBGView;
@property (nonatomic, strong) UIView *navView;
@property (nonatomic, strong) UIView *navNewView;
@property (nonatomic, strong) UIView *topHeaderView;
@property (nonatomic, assign) NSInteger dataCount;

@end

@implementation TBRefreshVC

- (void)dealloc {
    [self removeObserver:self forKeyPath:@"contentSize"];
}
- (void)viewDidLoad {
    [super viewDidLoad];
    
    self.navigationController.navigationBar.hidden = YES;
    
    [self.view addSubview:self.navBGView];
    [self.view addSubview:self.navView];
    [self.view addSubview:self.navNewView];
    [self.view addSubview:self.scrollView];
    [self.scrollView addSubview:self.topView];
    [self.scrollView addSubview:self.tableView];
    //æ·»åŠ åˆ·æ–°æ§ä»¶
    __weak TBRefreshVC *weakSelf = self;
    self.tableView.mj_header = [MJRefreshNormalHeader headerWithRefreshingBlock:^{
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(1 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
            [weakSelf.tableView.mj_header endRefreshing];
            weakSelf.dataCount += 5;
            [weakSelf.tableView reloadData];
        });
    }];
    
    self.scrollView.mj_footer = [MJRefreshBackNormalFooter footerWithRefreshingBlock:^{
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(1 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
            [weakSelf.scrollView.mj_footer endRefreshing];
            weakSelf.dataCount += 5;
            [weakSelf.tableView reloadData];
        });
    }];
    
    
    [self.tableView addObserver:self forKeyPath:@"contentSize" options:NSKeyValueObservingOptionNew context:nil];
    self.dataCount = 20;
}
//æ ¹æ®tableViewçš„contentSizeæ”¹å˜scrollViewçš„contentSizeå¤§å°
- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context {
    if ([keyPath isEqualToString:@"contentSize"]) {
        CGRect tFrame = self.tableView.frame;
        tFrame.size.height = self.tableView.contentSize.height;
        self.tableView.frame = tFrame;
        self.scrollView.contentSize = CGSizeMake(0, self.tableView.contentSize.height+KTopViewHeight);
    }
}

#pragma mark - UIScrollViewDelegate
- (void)scrollViewDidScroll:(UIScrollView *)scrollView {
    CGFloat offsetY = self.scrollView.contentOffset.y;
    if (offsetY &lt;= 0.0) {
        CGRect frame = self.topView.frame;
        frame.origin.y = offsetY;
        self.topView.frame = frame;
        CGRect tFrame = self.tableView.frame;
        tFrame.origin.y = offsetY + KTopViewHeight;
        self.tableView.frame = tFrame;
        if (![self.tableView.mj_header isRefreshing]) {
            self.tableView.contentOffset = CGPointMake(0, offsetY);
        }
    } else if (offsetY &lt; KTopHeaderViewHeight &amp;&amp; offsetY &gt;0) {
        CGFloat alpha =  (offsetY*2/KTopHeaderViewHeight&gt;0) ? offsetY*2/KTopHeaderViewHeight:0;
        if (alpha &gt; 0.5) {
            self.navNewView.alpha = alpha*2-1;
            self.navView.alpha = 0;
        } else {
            self.navNewView.alpha = 0;
            self.navView.alpha = 1-alpha*2;
        }
        self.topHeaderView.alpha = 1-alpha;
    }
}
- (void)scrollViewDidEndDragging:(UIScrollView *)scrollView willDecelerate:(BOOL)decelerate {
    CGFloat offsetY = self.scrollView.contentOffset.y;
    if (offsetY &lt; - 60) {
        [self.tableView.mj_header beginRefreshing];
    }
}
#pragma mark - UITableViewDataSource
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section {
    return self.dataCount;
}
- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath {
    UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:@"CELL"];
    if (cell == nil) {
        cell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:@"CELL"];
    }
    cell.textLabel.text = [NSString stringWithFormat:@"%d",(int)indexPath.row];
    return cell;
}
#pragma mark - getter &amp;&amp; setter
- (UIScrollView *)scrollView {
    if (_scrollView == nil) {
        _scrollView = [[UIScrollView alloc] initWithFrame:CGRectMake(0, 64, KScreenWidth, KScreenHeight-64)];
        _scrollView.delegate = self;
        //Indicatorçš„æ˜¾ç¤ºä½ç½®
        _scrollView.scrollIndicatorInsets = UIEdgeInsetsMake(KTopViewHeight, 0, 0, 0);
        _scrollView.contentSize = CGSizeMake(0, KScreenHeight*2);
    }
    return _scrollView;
}
- (UITableView *)tableView {
    if (_tableView == nil) {
        _tableView = [[UITableView alloc] initWithFrame:CGRectMake(0, KTopViewHeight, KScreenWidth, KScreenHeight*2-KTopViewHeight)];
        _tableView.delegate = self;
        _tableView.dataSource = self;
        _tableView.scrollEnabled = NO;
    }
    return _tableView;
}
- (UIView *)topView {
    if (_topView == nil) {
        _topView = [[UIView alloc] initWithFrame:CGRectMake(0, 0, KScreenWidth, KTopViewHeight)];
        _topView.backgroundColor = UIColor.grayColor;
        
        UIView *headerView = [[UIView alloc] initWithFrame:CGRectMake(0, 0, KScreenWidth, KTopHeaderViewHeight)];
        headerView.backgroundColor = UIColor.blackColor;
        for (int i = 0; i&lt;4; i++) {
            UIButton *button = [[UIButton alloc] init];
            [button setImage:[UIImage imageNamed:[NSString stringWithFormat:@"%d",i+1]] forState:UIControlStateNormal];
            [headerView addSubview:button];
            button.frame = CGRectMake((KScreenWidth/4)*i, 0, KScreenWidth/4, KTopHeaderViewHeight);
        }
        self.topHeaderView = headerView;
        [_topView addSubview:headerView];
        UIView *view = [[UIView alloc] initWithFrame:CGRectMake(0, KTopHeaderViewHeight, KScreenWidth, KTopViewHeight-KTopHeaderViewHeight)];
        view.backgroundColor = [UIColor systemPinkColor];
        [_topView addSubview:view];
    }
    return _topView;
}
- (UIView *)navBGView {
    if (_navBGView == nil) {
        _navBGView = [[UIView alloc] initWithFrame:CGRectMake(0, 0, KScreenWidth, 64)];
        _navBGView.backgroundColor = UIColor.yellowColor;
    }
    return _navBGView;
}
- (UIView *)navView {
    if (_navView == nil) {
        _navView = [[UIView alloc] initWithFrame:CGRectMake(0, 0, KScreenWidth, 64)];
        _navView.backgroundColor = [UIColor clearColor];
        UISearchBar *searchBar = [[UISearchBar alloc] initWithFrame:CGRectMake(10, 20, 200, 44)];
        searchBar.backgroundImage = [[UIImage alloc] init];
        UITextField *searchField = [searchBar valueForKey:@"searchField"];
        if (searchField) {
            [searchField setBackgroundColor:[UIColor colorWithRed:230/255 green:230/250 blue:230/250 alpha:0.1]];
        }
        [_navView addSubview:searchBar];
        UIButton *button = [[UIButton alloc] initWithFrame:CGRectMake(220, 20, 44, 44)];
        [button setImage:[UIImage imageNamed:@"contacts"] forState:UIControlStateNormal];
        [_navView addSubview:button];
    }
    return _navView;
}
- (UIView *)navNewView {
    if (_navNewView == nil) {
        _navNewView = [[UIView alloc] initWithFrame:CGRectMake(0, 0, KScreenWidth, 64)];
        _navNewView.backgroundColor = [UIColor clearColor];
        UIButton *cameraBtn = [[UIButton alloc] initWithFrame:CGRectMake(10, 20, 44, 44)];
        [cameraBtn setImage:[UIImage imageNamed:@"nav_camera"] forState:UIControlStateNormal];
        cameraBtn.backgroundColor = UIColor.redColor;
        [_navNewView addSubview:cameraBtn];
        UIButton *payBtn = [[UIButton alloc] initWithFrame:CGRectMake(64, 20, 44, 44)];
        [payBtn setImage:[UIImage imageNamed:@"nav_pay"] forState:UIControlStateNormal];
        payBtn.backgroundColor = UIColor.greenColor;
        [_navNewView addSubview:payBtn];
        UIButton *button = [[UIButton alloc] initWithFrame:CGRectMake(118, 20, 44, 44)];
        [button setImage:[UIImage imageNamed:@"nav_scan"] forState:UIControlStateNormal];
        button.backgroundColor = UIColor.blueColor;
        [_navNewView addSubview:button];
        _navNewView.alpha = 0;
    }
    return _navNewView;
}

@end
</code></pre></div></div>

:ET